name: Cache Configuration

on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string
        description: "Platform (macos/windows)"
      setup_python:
        required: true
        type: boolean
        description: "Whether to set up Python"
      setup_rust:
        required: true
        type: boolean
        description: "Whether to set up Rust"
      setup_node:
        required: true
        type: boolean
        description: "Whether to set up Node.js"
    outputs:
      python-venv-cache-hit:
        description: "Whether Python virtual environment cache was hit"
        value: ${{ jobs.cache.outputs.python-venv-cache-hit }}
      node-cache-hit:
        description: "Whether Node.js cache was hit"
        value: ${{ jobs.cache.outputs.node-cache-hit }}
      rust-cache-hit:
        description: "Whether Rust cache was hit"
        value: ${{ jobs.cache.outputs.rust-cache-hit }}

jobs:
  cache:
    runs-on: ${{ inputs.platform }}-latest
    outputs:
      python-venv-cache-hit: ${{ steps.python-venv-cache.outputs.cache-hit }}
      node-cache-hit: ${{ steps.node-cache.outputs.cache-hit }}
      rust-cache-hit: ${{ steps.rust-cache.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Python virtual environment
        if: inputs.setup_python
        uses: actions/cache@v4
        id: python-venv-cache
        with:
          path: ${{ runner.tool_cache }}/venv
          key: ${{ runner.os }}-${{ runner.arch }}-venv-${{ hashFiles('infra/packages/pip.sh', 'infra/packages/pip.ps1') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-venv-

      - name: Cache Node.js packages
        if: inputs.setup_node
        uses: actions/cache@v4
        id: node-cache
        with:
          path: ~/.npm
          key: ${{ runner.os }}-${{ runner.arch }}-npm-${{ hashFiles('infra/packages/npm.sh', 'infra/packages/npm.ps1') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-npm-

      - name: Cache Rust packages
        if: inputs.setup_rust
        uses: actions/cache@v4
        id: rust-cache
        with:
          path: |
            ~/.cargo
            ~/.rustup
          key: ${{ runner.os }}-${{ runner.arch }}-rust-${{ hashFiles('infra/packages/cargo.sh', 'infra/packages/cargo.ps1') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-rust-
